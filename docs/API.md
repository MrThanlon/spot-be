# spot抢答器接口文档

![](https://img.shields.io/badge/license-AGPL-green.svg)

> 献给广大的成电单身狗们~

## 说明

为了压缩体积，客户端接口使用二进制格式。

## 抢答器客户端接口

### 获取当前时钟

@request

| 数据长度(bytes) |   参数   |     说明     |
| :-------------: | :------: | :----------: |
|        1        | 请求标识 | 固定为`0x00` |

也就是ASCII第一个字符。

@return

| 数据长度(bytes) |        参数        |             说明              |
| :-------------: | :----------------: | :---------------------------: |
|        1        |      响应标识      |         固定为`0x00`          |
|        4        | 当前时间，单位毫秒 | 例如1520390毫秒为`0x00173306` |

此时间用于给客户端同步时钟，建议客户端考虑RTT进行校准。

### 注册

客户端在注册之后才能发起抢答，否则无效。可以重复注册，但是不建议这么做。

@request

| 数据长度(bytes) |   参数   |     说明     |
| :-------------: | :------: | :----------: |
|        1        | 请求标识 | 固定为`0x01` |

也就是ASCII第二个字符。

@return

| 数据长度(bytes) |           说明           |
| :-------------: | :----------------------: |
|        1        |  响应标识，固定为`0x01`  |
|        4        | 身份ID，抢答时候需要提交 |

### 抢答

@request

| 数据长度(bytes) |    参数    |          说明          |
| :-------------: | :--------: | :--------------------: |
|        1        |  请求标识  |      固定为`0x03`      |
|        4        |   身份ID   |  之前注册获取到的数字  |
|        4        | 抢答的时间 | 当前系统时钟，单位毫秒 |

@return

| 数据长度(bytes) |   参数   |                             说明                             |
| :-------------: | :------: | :----------------------------------------------------------: |
|        1        | 响应标识 |                         固定为`0x03`                         |
|        1        |  状态码  | 0.抢答成功<br />1.未注册/已经抢答/不在抢答时间<br />2.时间误差过大<br />需要注意即使犯规也视为抢答成功 |

需要注意当返回为2的时候（即时间误差过大），抢答依然有效，但是会以系统时间作为标尺（会计算RTT），此时为保证下次抢答不出问题建议客户端再次进行时钟同步。

## Web后台接口

WebSocket协议使用3000端口，HTTP协议使用8090端口。

#### 前端静态文件

直接用浏览器请求即可，文件位于`/www`目录下，请求路径为`/www`。

### 消息接口

#### 抢答事件

WebSocket协议。请求路径为`/msg`。消息格式为JSON。发生抢答时推送。

```jsonc
{
		stat: Number, //当前状态
		ct: Number, //服务器当前时间
		nt: Number, //倒计时剩余，单位毫秒
    reg: Number, //用户数量
    nr: Number, //距离开始的用时，用于判断暂停之前的阶段
    res: [
        Number, //结果，未抢答的为0，犯规提前时间（负值，毫秒），正常抢答的为抢答用时（毫秒），为开始状态时全为0
        ...
    ],
    user: Number|null //抢答的用户，没有则为空
}
```

#### 配置修改事件

WebSocket协议。请求路径为`/config`。消息格式为JSON。配置文件修改时推送。包括

- 状态，stat，0.未开始，1.倒计时阶段，2.抢答阶段，3.抢答结束，4.暂停
- 抢答倒计时事件，t1，毫秒
- 抢答时间，t2，毫秒

```
{
  	stat: Number,
  	t1: Number,
  	t2: Number,
  	names: [
      String, //设定的用户名，索引为id，无名为null
      ...
  	]
}
```

### 控制接口

控制接口的路径都为`/ctr`，请求参数使用URL编码发送，kv对形式。若无特殊说明，响为状态码

- 0.成功
- 1.失败

#### 开始

@request

```json
act=start
```

#### 重置

@request

```
act=reset
```

#### 修改抢答倒计时时间

如果不使用倒计时，修改成0即可。val仅为正整数。

@request

```
act=modt&val=<需要修改的时间值，单位毫秒>
```

例如将倒计时改为3000毫秒，则请求`/ctr?act=modt&val=3000`。

#### 修改抢答时间

@request

```
act=modt2&val=<需要修改的时间值，单位毫秒>
```

例如将倒计时改为10秒，则请求`/ctr?act=modt2&val=10000`。

#### 暂停

@request

```
act=pause
```

仅在抢答阶段或者倒计时阶段使用，可以暂停当前状态，暂停期间主机会忽略客户端的抢答和注册请求。已经暂停的情况下不允许再次使用暂停指令。

#### 恢复

对应请求暂停，暂停过程中可以使用这个命令继续。

@request

```
act=continue
```

#### 读取各个客户端的RTT

响应格式为JSON。

@request

```
act=rtt
```

@return

```
{
    stat: Number, //状态码，0.成功，1.失败
    data:[
        Number, //RTT值，index为选手ID
        ...
    ]
}
```

#### 设置允许的客户端误差

@request

```
act=valid&id=<选手ID>&rtt=<设置值>
```

#### 设置选手名称

@request

```
act=name&id=<选手ID>&name=<名称>
```
